# SECURITY.md — Безопасность и RLS (Supabase)

## Ключевые принципы
1. **Секреты только на сервере.** Никогда не кладём `SUPABASE_SERVICE_ROLE_KEY`, `GITHUB_TOKEN`, `TELEGRAM_BOT_TOKEN` в клиентский код или в репозиторий. Использовать секреты в CI/CD и server-side actions.
2. **Минимум привилегий.** Серверные операции выполняются под `service_role` только в server-side code (API routes / Server Actions).
3. **RLS = обязанность.** Включить Row Level Security на всех таблицах с приватными данными (`users`, `rentals`, `invoices`, `payments`, `ai_requests`).

## Быстрый набор рекомендаций для RLS (пример)
-- Пример: rentals (Postgres)
-- 1) Включаем RLS
ALTER TABLE public.rentals ENABLE ROW LEVEL SECURITY;

-- 2) Разрешаем чтение владельцу (renter) и владельцу транспорта (owner)

-- 3) Разрешаем вставку авторизованным пользователям (пример)

-- 4) Разрешаем апдейт владельцу транспорта (ограничьте поля)

## Хранение ключей

* Разместите секреты в GitHub Secrets / Vercel Secrets / Environment variables CI.
* Периодическая ротация (90 дней) — обязана для prod-ключей.
* Логирование ошибок — без секретов. Не логируйте полные payload’ы платежей.

## Storage buckets (Supabase) — рекомендации безопасности

* Buckets с публичными изображениями (обложки) — `public-read` OK.
* Buckets с приватными материалами (фото до/после аренды, invoices) — `private`. Доступ через Роу-интеграцию или временные ссылки (signed URLs).
* Пример политики (RLS + storage policy): не полагайтесь только на ACL — проверяйте авторизацию на server-side при выдаче signed URL.

## Webhooks & Telegram

* Валидация входящих запросов (подпись, токен).
* Не выполняйте критичные операции (например, начисление звезд) сразу на одном событии — используйте проверку idempotency и запись в DB + фоновые проверки.

## Инцидент-реакция

1. При утечке ключа — немедленно вращайте ключи, инвалидируйте сессии, сообщите пользователям (если данные скомпрометированы).
2. Логи в Sentry / Datadog с маскированием PII.
3. Пост-фиксовый план: write-up, исправление политики, регресс-тест.

## Audit & тесты

* Еженедельный тест RLS policy (integration tests).
* CI job: `rsl-check` — прогон SQL-политик и тестов на моках.