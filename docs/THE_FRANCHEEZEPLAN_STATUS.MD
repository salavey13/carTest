# üèÅ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢: –ó–ê–ü–£–°–ö –§–†–ê–ù–®–ò–ó–´

**–î–ê–¢–ê:** 26 –§–µ–≤—Ä–∞–ª—è 2026

–ö–æ–º–∞–Ω–¥–∞, –º—ã –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —É —Ü–µ–ª–∏. –°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞, –¥–∏–∑–∞–π–Ω –≤–Ω–µ–¥—Ä–µ–Ω, –ø–ª–∞—Ç–µ–∂–∏ —Ä–∞–±–æ—Ç–∞—é—Ç. –û—Å—Ç–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä—ã–≤–æ–∫ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏. –≠—Ç–æ –±—ã–ª–∞ –æ–≥—Ä–æ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –∏ —Ñ–∏–Ω–∏—à —É–∂–µ –≤–∏–¥–µ–Ω.

---

## üöÄ –ì–õ–ê–í–ù–´–ï –¶–ò–§–†–´

| –ú–ï–¢–†–ò–ö–ê | –ó–ù–ê–ß–ï–ù–ò–ï | –°–¢–ê–¢–£–° |
| :--- | :--- | :--- |
| **–ì–û–¢–û–í–ù–û–°–¢–¨** | **(bg-green) (white) 99%** | (green) **–§–ò–ù–ò–®–ù–ê–Ø –ü–†–Ø–ú–ê–Ø** |
| **–í–´–ü–û–õ–ù–ï–ù–û** | **62 / 63** | (green) **–ò–î–ï–ú –ü–û –ü–õ–ê–ù–£** |
| **–î–ï–ù–¨–ì–ò (TTFM)** | **(bg-black) (green) 00:00:00:00** | (bg-emerald) (white) **–ü–õ–ê–¢–ï–ñ–ò –ê–ö–¢–ò–í–ù–´** |
| **–¢–ï–ö–£–©–ò–ô –≠–¢–ê–ü** | **(bg-yellow) (black) –ó–ê–ö–ê–õ–ö–ê** | (orange) **–í –†–ê–ë–û–¢–ï** |

> **–¢–∞–π–º–µ—Ä –¥–æ –ø–µ—Ä–≤—ã—Ö –¥–µ–Ω–µ–≥ (TTFM):** –°–∏—Å—Ç–µ–º–∞ **(green) –ñ–ò–í–ê–Ø**. –ü—Ä–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ Telegram Stars (XTR) –≤–∫–ª—é—á–µ–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω. –ú—ã —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –≥–æ—Ç–æ–≤—ã –ø—Ä–∏–Ω—è—Ç—å –ø–µ—Ä–≤—É—é —Ä–µ–∞–ª—å–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.

---

## üìã –î–û–°–ö–ê –ó–ê–î–ê–ß (–ü–£–¢–¨ –ö –£–°–ü–ï–•–£)

*–ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç ‚Äî –∑–∞–¥–∞—á–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã—Ç–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç.*

| ID | –°–¢–ê–¢–£–° | –ß–¢–û –°–î–ï–õ–ê–ù–û | –ö–¢–û |
| :--- | :--- | :--- | :--- |
| **T1** | (bg-green) (white) –ì–û–¢–û–í–û | –§—É–Ω–¥–∞–º–µ–Ω—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è | codex |
| **T2** | (bg-green) (white) –ì–û–¢–û–í–û | –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤ | codex |
| **T3** | (bg-green) (white) –ì–û–¢–û–í–û | –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü | codex |
| **T3a** | (bg-green) (white) –ì–û–¢–û–í–û | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–º–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ | codex |
| **T3b** | (bg-green) (white) –ì–û–¢–û–í–û | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—É—Ç–µ–π | codex |
| **T4** | (bg-green) (white) –ì–û–¢–û–í–û | –î–∏–∑–∞–π–Ω-–æ–±–æ–ª–æ—á–∫–∞ (—Å—Ç–∏–ª—å Pepperolli) | codex |
| **T5** | (bg-green) (white) –ì–û–¢–û–í–û | –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ (–ú–æ–±–∏–ª—å–Ω—ã–π –≤–∏–¥) | codex |
| **T5x** | (bg-green) (white) –ì–û–¢–û–í–û | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ | codex |
| **T6** | (bg-green) (white) –ì–û–¢–û–í–û | –ö–æ—Ä–∑–∏–Ω–∞ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ | codex |
| **T7** | (bg-green) (white) –ì–û–¢–û–í–û | –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ñ—Ä–∞–Ω—à–∏–∑ (No-code) | codex |
| **T8** | (bg-green) (white) –ì–û–¢–û–í–û | –ë–µ—Å—à–æ–≤–Ω—ã–π –ø–µ—Ä–µ–µ–∑–¥ —Å–æ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ | codex |
| **T8.1** | (bg-green) (white) –ì–û–¢–û–í–û | –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π | codex |
| **T8.2** | (bg-green) (white) –ì–û–¢–û–í–û | "–ñ–∏–≤–∞—è —Å—Ç—Ä–æ–∫–∞" –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è | codex |
| **T8.3** | (bg-green) (white) –ì–û–¢–û–í–û | –ß–∏—Å—Ç–∫–∞ —à–∞–ø–∫–∏ –∏ –ø–æ–¥–≤–∞–ª–∞ —Å–∞–π—Ç–∞ | codex |
| **T8.4** | (bg-green) (white) –ì–û–¢–û–í–û | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è VibeMap (–ö–∞—Ä—Ç—ã) | codex |
| **T8.5** | (bg-green) (white) –ì–û–¢–û–í–û | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏ —Å–æ—Ü—Å–µ—Ç–µ–π | codex |
| **T8.6** | (bg-green) (white) –ì–û–¢–û–í–û | –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–ª–∏—Ä–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤ | codex |
| **T9** | (bg-green) (white) –ì–û–¢–û–í–û | QA, –¢–µ—Å—Ç—ã –∏ –°–∫—Ä–∏–Ω—à–æ—Ç—ã | codex |
| **T10** | (bg-green) (white) –ì–û–¢–û–í–û | –ê–≤—Ç–æ-—Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ | codex |
| **T11** | (bg-green) (white) –ì–û–¢–û–í–û | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é –∏ –Ω–∞–ª–æ–∂–µ–Ω–∏–π | codex |
| **T12** | (bg-green) (white) –ì–û–¢–û–í–û | –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ | codex |
| **T13** | (bg-green) (white) –ì–û–¢–û–í–û | –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ | codex |
| **T14** | (bg-green) (white) –ì–û–¢–û–í–û | –°–≤—è–∑–∫–∞ –ö–æ—Ä–∑–∏–Ω–∞ -> –ê—Ä–µ–Ω–¥–∞ | codex |
| **T15** | (bg-green) (white) –ì–û–¢–û–í–û | –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∞—Ä–µ–Ω–¥—ã (Telegram) | codex |
| **T16** | (bg-green) (white) –ì–û–¢–û–í–û | –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞ | codex |
| **T16A** | (bg-green) (white) –ì–û–¢–û–í–û | –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∫–ª–∏–∫–æ–≤ (–§–∏–∫—Å —Ç–∞–ø–æ–≤) | codex |
| **T16B** | (bg-green) (white) –ì–û–¢–û–í–û | –í–æ–∑–≤—Ä–∞—Ç –≤ –∫–∞—Ç–∞–ª–æ–≥ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü | codex |
| **T16C** | (bg-green) (white) –ì–û–¢–û–í–û | –£–º–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º | codex |
| **T16D** | (bg-green) (white) –ì–û–¢–û–í–û | –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å" | codex |
| **T16E** | (bg-green) (white) –ì–û–¢–û–í–û | –§–∏–∫—Å –ª–æ–≥–æ—Ç–∏–ø–∞ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ | codex |
| **T17** | (bg-green) (white) –ì–û–¢–û–í–û | –¶–≤–µ—Ç–æ–≤–∞—è –≥–∞—Ä–º–æ–Ω–∏—è (–¢–µ–º–Ω–∞—è/–°–≤–µ—Ç–ª–∞—è) | codex |
| **T18** | (bg-green) (white) –ì–û–¢–û–í–û | –£–ª—É—á—à–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä —Ü–≤–µ—Ç–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ | codex |
| **T19** | (bg-green) (white) –ì–û–¢–û–í–û | –ß–∏—Å—Ç–∫–∞ —Å—Ç–∏–ª–µ–π –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –æ–∫–æ–Ω | codex |
| **T20** | (bg-green) (white) –ì–û–¢–û–í–û | –°—Ç–∏–ª—å –ø–ª–∞–≤–∞—é—â–µ–π –∫–æ—Ä–∑–∏–Ω—ã | codex |
| **T21** | (bg-green) (white) –ì–û–¢–û–í–û | –£–ª—É—á—à–µ–Ω–∏–µ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ (–ö–∞—Ä—Ç—ã/–ö–∞—Ç–∞–ª–æ–≥) | codex |
| **T22** | (bg-green) (white) –ì–û–¢–û–í–û | –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ | codex |
| **T23** | (bg-green) (white) –ì–û–¢–û–í–û | –ò–∑–æ–ª—è—Ü–∏—è —Å—Ç–∏–ª–µ–π –ø–ª–∏—Ç–æ–∫ –∫–∞—Ç–∞–ª–æ–≥–∞ | codex |
| **T24** | (bg-green) (white) –ì–û–¢–û–í–û | –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ (–§–æ–∫—É—Å) | codex |
| **T25** | (bg-green) (white) –ì–û–¢–û–í–û | –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ | codex |
| **T26** | (bg-green) (white) –ì–û–¢–û–í–û | –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞ | codex |
| **T27** | (bg-green) (white) –ì–û–¢–û–í–û | "–í—Ç–æ—Ä–æ–π –ø–∏–ª–æ—Ç" –Ω–∞ –∫–∞—Å—Å–µ | codex |
| **T28** | (bg-green) (white) –ì–û–¢–û–í–û | –ü–∞–Ω–µ–ª—å –∑–∞–ø—É—Å–∫–∞ —Ñ—Ä–∞–Ω—à–∏–∑—ã | codex |
| **T29** | (bg-green) (white) –ì–û–¢–û–í–û | –ü—Ä–æ–º–æ-–±–ª–æ–∫–∏ (–∫–∞–∫ –Ω–∞ Pepperolli) | codex |
| **T30** | (bg-green) (white) –ì–û–¢–û–í–û | –°—á–µ—Ç—á–∏–∫ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Å–±—Ä–æ—Å –ø–æ–∏—Å–∫–∞ | codex |
| **T31** | (bg-green) (white) –ì–û–¢–û–í–û | –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (–≠–Ω–µ—Ä–≥–∏—è) | codex |
| **T32** | (bg-green) (white) –ì–û–¢–û–í–û | –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è —É–º–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ | codex |
| **T33** | (bg-green) (white) –ì–û–¢–û–í–û | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–æ–π –∏–∑ –∞–¥–º–∏–Ω–∫–∏ | codex |
| **T34** | (bg-green) (white) –ì–û–¢–û–í–û | –£–º–Ω–∞—è –ª–µ–Ω—Ç–∞ –∫–∞–º–ø–∞–Ω–∏–π | codex |
| **T35** | (bg-green) (white) –ì–û–¢–û–í–û | –ü–ª–∞–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã (SPA) | codex |
| **T36** | (bg-green) (white) –ì–û–¢–û–í–û | –°–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–æ—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (–ú–æ–±–∞–π–ª) | codex |
| **T37** | (bg-green) (white) –ì–û–¢–û–í–û | –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ç–∏–∫–µ—Ä –∞—É–∫—Ü–∏–æ–Ω–∞ | codex |
| **T38** | (bg-green) (white) –ì–û–¢–û–í–û | –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ | codex |
| **T39** | (bg-green) (white) –ì–û–¢–û–í–û | –õ–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É | codex |
| **T40** | (bg-green) (white) –ì–û–¢–û–í–û | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –≤ –æ–±–ª–∞–∫–µ | codex |
| **T41** | (bg-green) (white) –ì–û–¢–û–í–û | –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–¥–≤–∞–ª–µ | codex |
| **T42** | (bg-green) (white) –ì–û–¢–û–í–û | –£–º–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —à–∞–ø–∫–∏ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ | codex |
| **T43** | (bg-green) (white) –ì–û–¢–û–í–û | –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å—Ç–∏–ª–µ–π | codex |
| **T44** | (bg-green) (white) –ì–û–¢–û–í–û | –ê–≤—Ç–æ-—Ç–µ—Å—Ç—ã –∫–ª–∏–∫–æ–≤ | codex |
| **T45** | (bg-green) (white) –ì–û–¢–û–í–û | –ó–∞—â–∏—Ç–∞ –∫–æ—Ä–∑–∏–Ω—ã + –±–∏—Ç—ã–µ —Å—Å—ã–ª–∫–∏ | codex |
| **T46** | (bg-green) (white) –ì–û–¢–û–í–û | –í—ã–±–æ—Ä "–ê—É–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–∏–∫–∞" | codex |
| **T47** | (bg-green) (white) –ì–û–¢–û–í–û | –ü–ª–∞–Ω —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Å–≤–µ—Ä–∫–∏ | codex |
| **T48** | (bg-green) (white) –ì–û–¢–û–í–û | –ü–æ–ª–Ω–∞—è –∫–æ–ø–∏—è —Å—Ç–∏–ª—è Pepperolli (–í–∏–∑—É–∞–ª) | codex |
| **T49** | (bg-yellow) (black) –í –†–ê–ë–û–¢–ï | **–§–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω–∂–µ–Ω–µ—Ä–Ω–∞—è –∑–∞—â–∏—Ç–∞** | codex |

---

**‚ÑπÔ∏è –ß–¢–û –î–ê–õ–¨–®–ï?**

–ú—ã —Å–µ–π—á–∞—Å –Ω–∞ –∑–∞–¥–∞—á–µ **T49**. –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ä—É–±–µ–∂:
1.  **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ß—Ç–æ–±—ã –Ω–∏–∫—Ç–æ –Ω–µ –≤–∑–ª–æ–º–∞–ª –∞–¥–º–∏–Ω–∫—É.
2.  **–°–∫–æ—Ä–æ—Å—Ç—å:** –ß—Ç–æ–±—ã –ø–µ—Ä–µ—Ö–æ–¥—ã –±—ã–ª–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º–∏ (SPA), –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫.
3.  **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ß—Ç–æ–±—ã –∫–æ—Ä–∑–∏–Ω–∞ –Ω–µ —Ç–µ—Ä—è–ª–∞—Å—å –ø—Ä–∏ –ø–ª–æ—Ö–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ.

–ö–∞–∫ —Ç–æ–ª—å–∫–æ T49 —Å—Ç–∞–Ω–µ—Ç –∑–µ–ª–µ–Ω—ã–º ‚Äî –º—ã –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –≥–æ—Ç–æ–≤—ã –∫ —Ä–µ–ª–∏–∑—É. **–ù–µ —Å–¥–∞–≤–∞–π—Ç–µ—Å—å, –º—ã —É–∂–µ –∑–¥–µ—Å—å!**
### `docs/T49-security_sweep.md`

# T49 ‚Äî ENGINEERING HARDENING SWEEP

**Status:** IN PROGRESS
**Owner:** `codex`
**Context:** Security boundary enforcement, SPA recovery, and architecture cleanup.

---

## üõ°Ô∏è EXECUTED HARDENING (READY FOR RE-APPLICATION)

The following critical fixes have been implemented and verified.

### 1. Header Transition Smoothing
**(bg-purple) (white) UX / ANIMATION**
- **Fix:** Replaced jittery `maxHeight` transition with `transform: scaleY(0.85) translateY(-8px)`.
- **Tech:** Added `transformOrigin: 'top center'`, `cubic-bezier(0.4, 0, 0.2, 1)`, and `pointerEvents` toggling.
- **Result:** buttery smooth collapse without layout thrashing.

### 2. Security Boundary: Server-Only Admin
**(bg-red) (white) SECURITY / ARCHITECTURE**
- **Fix:** Enforced physical separation of privileged Supabase clients.
- **Implementation:**
  - Installed `server-only` package.
  - Created `src/lib/supabase-server.ts` (proxies admin access).
  - Updated `src/hooks/supabase.ts` to import from the safe server module.
- **Result:** Client bundle build fails immediately if `SUPABASE_SERVICE_ROLE_KEY` is referenced.

---

## üöß REMAINING SUBTASK MATRIX

This matrix drives the final rollout phase.

| ID | TYPE | TASK SCOPE | COMPLEXITY | STATUS |
| :--- | :--- | :--- | :--- | :--- |
| **49.3** | (bg-blue) (white) **ARCH** | **SPA Recovery**<br>Restore `next/link` & `router.push` in place of full reloads | (bg-orange) (black) **HIGH** | (gray) **TODO** |
| **49.4** | (bg-blue) (white) **ARCH** | **Tap Reliability**<br>Audit z-index stacking & overlay click propagation | (bg-yellow) (black) **MED** | (gray) **TODO** |
| **49.5** | (bg-purple) (white) **PERF** | **Cart DB Guard**<br>Implement debounce & checkpoint-only persistence | (bg-yellow) (black) **MED** | (gray) **TODO** |
| **49.6** | (bg-pink) (white) **CSS** | **Style System Migration**<br>Move `crew.palette` to CSS variables for Tailwind utility support | (bg-orange) (black) **HIGH** | (gray) **TODO** |
| **49.7** | (bg-blue) (white) **ARCH** | **Context Decomposition**<br>Split monolithic `AppContext` into logical atomic providers | (bg-red) (white) **CRITICAL** | (gray) **TODO** |
| **49.8** | (bg-purple) (white) **UX** | **Theme Flash Fix**<br>Server-side cookie hint to prevent light-mode flash | (bg-green) (white) **LOW** | (gray) **TODO** |
| **49.9** | (bg-purple) (white) **PERF** | **Memo Rollback**<br>Remove cargo-cult `React.memo` usage on lightweight components | (bg-green) (white) **LOW** | (gray) **TODO** |
| **49.10** | (bg-red) (white) **SEC** | **AI JSON Safety**<br>Resilient parsing & validation for AI-generated payloads | (bg-yellow) (black) **MED** | (gray) **TODO** |
| **49.11** | (bg-gray) (white) **QA** | **Regression Pack**<br>Full smoke test of navigation flows on mobile | (bg-yellow) (black) **MED** | (gray) **TODO** |

---

## üîß IMPLEMENTATION DETAILS (COMPLETED)

### A. Server-Only Module Implementation
**File:** `src/lib/supabase-server.ts`

`typescript
import 'server-only';
import { createClient } from "@supabase/supabase-js";
// ... (code for admin client proxy)
`

### B. Header Animation Fix
**File:** `app/franchize/components/CrewHeader.tsx`

`tsx
<div style={{
  transform: isCompact ? 'scaleY(0.85) translateY(-8px)' : 'scaleY(1) translateY(0)',
  transformOrigin: 'top center',
  transition: 'transform 0.35s cubic-bezier(0.4, 0, 0.2, 1)',
  pointerEvents: isCompact ? 'none' : 'auto',
}}>
`

---

## ‚úÖ ACCEPTANCE CRITERIA

- [x] **Security:** No client bundle access to `SUPABASE_SERVICE_ROLE_KEY`.
- [ ] **Nav:** Internal links use SPA transitions (no white flash).
- [ ] **Data:** Cart writes are batched/checkpointed (not on every keystroke).
- [ ] **Styles:** Interaction states (hover/focus) work via CSS variables.
- [ ] **State:** Context updates do not re-render the entire app tree.
- [ ] **UX:** Dark mode users never see a white flash on load.

–ö–∞–∫ —Ç–æ–ª—å–∫–æ T49 —Å—Ç–∞–Ω–µ—Ç –∑–µ–ª–µ–Ω—ã–º ‚Äî –º—ã –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –≥–æ—Ç–æ–≤—ã –∫ —Ä–µ–ª–∏–∑—É. **–ù–µ —Å–¥–∞–≤–∞–π—Ç–µ—Å—å, –º—ã —É–∂–µ –∑–¥–µ—Å—å!**
---

## UPDATE 2026-02-27 (T49 planning sync)
- T49 replanned into explicit dependency chain in `docs/T49-security_sweep.md` and mirrored in `docs/THE_FRANCHEEZEPLAN.md`.
- `T49.0` completed first: historical diary bulk extracted from THE plan and archived in `docs/AGENT_DIARY.md`.
- Next active substep: `T49.1` (security boundary verification), then continue strictly in order through SPA/state/style/theme hardening.
- Follow-up correction: restored technical-depth T49 subtask details (file anchors + verification commands) and replaced placeholder prefix with exact required phrase `continue as FRANCHEEZEPLAN_EXECUTIONER`.

## UPDATE 2026-02-27 (T49 reapply pack)
- Reapplied tested T49 hardening snippets into main repo: smooth `CrewHeader` transform collapse, server-only Supabase admin module, and dropdown click-layer reliability fixes.
- Security boundary now has explicit `lib/supabase-server.ts` (`server-only`) and `hooks/supabase.ts` consumes re-exported admin helpers instead of in-file service-role wiring.
- Next sequential beat remains T49.2‚ÄìT49.6 (SPA oath recovery audit, cart checkpoint persistence smoke, style-system breadth migration, context split strategy, theme-flash/AI-JSON resilience).

## UPDATE 2026-02-27 (T49.2 SPA deep-link follow-up)
- Extended SPA oath fix into `FranchizeRentalLifecycleActions`: same-origin `deepLink` now uses `router.push(...)`, while external Telegram links still use browser navigation.
- This removes accidental hard reload for internal links without breaking Telegram handoff flows.
- Next beat: complete remaining franchize-shell SPA audit and continue into T49.3 cart checkpoint persistence verification.

## UPDATE 2026-02-27 (T49.2 deep-link safety guard)
- Added safety gate for franchize lifecycle deep-links: only `http/https/tg` protocols are allowed.
- Malformed or unsafe deep-links now show explicit toast error, preventing accidental unsafe navigation paths.
- SPA behavior for same-origin links remains preserved via `router.push(...)`.

## UPDATE 2026-02-27 (T49.2 cart page SPA links)
- Converted `/franchize/[slug]/cart` internal links (`back to catalog`, `checkout CTA`) from `<a href>` to Next.js `Link`.
- This removes residual hard-reload behavior on cart surface and aligns navigation with SPA oath contract.
- Next beat: final T49.2 grep/smoke and transition to T49.3 cart checkpoint persistence validation.

## UPDATE 2026-02-27 (T49.3 leave-scope cart flush)
- Added a new persistence checkpoint in `useFranchizeCart`: when route leaves `/franchize/{slug}*`, pending cart state is flushed immediately.
- This complements existing `/cart` + `/order/*` checkpoints and pagehide/visibility flushes.
- Goal: reduce lost cart metadata risk during SPA route exits on mobile sessions.

## UPDATE 2026-02-27 (T49.3 freeze lifecycle flush)
- Cart persistence now flushes on `document` `freeze` event in addition to `pagehide`/`visibilitychange`.
- This targets mobile Telegram/WebView suspend scenarios where unload semantics are unreliable.
- Next beat: verify route-exit + background/foreground resume durability, then advance to T49.4 style-system pass.

## UPDATE 2026-02-27 (T49.4 lifecycle style-token hotspot)
- Refactored `FranchizeRentalLifecycleActions` to use CSS-variable Tailwind color utilities instead of repeated per-button inline colors.
- Added explicit hover/focus-visible states tied to palette vars to keep keyboard/touch interaction visibility stable.
- Next beat: continue same cleanup pattern across remaining franchize hotspots and run interaction-state smoke.

## UPDATE 2026-02-27 (T49.4 cart style-token hotspot)
- Refactored `CartPageClient` accent/border/focus styles to use CSS-variable Tailwind utilities.
- Reduced inline color usage on cart CTA/price/qty controls while preserving crew-theme flexibility.
- Next beat: interaction-state smoke on cart + lifecycle + header controls before continuing T49.4 sweep.

## UPDATE 2026-02-27 (T49.4 catalog + item modal token sweep)
- Continued style-system migration by moving catalog/item-modal accent and muted color hotspots to scoped CSS variables consumed via Tailwind var utilities.
- `CatalogClient` now exposes `--catalog-*` vars for fallback notice, promo tile text, section headers/count pills, and product price/CTA badges.
- `ItemModal` now exposes `--item-*` vars and uses them across option chips, focus outlines, spec labels, and modal action buttons to reduce inline color/focus wiring.
- Next beat: run broader interaction-state smoke and finish remaining T49.4 hotspots before opening T49.5 context decomposition/realtime audit.

## UPDATE 2026-02-27 (T49.4 shell token sweep: footer + floating cart + header menu)
- Migrated `CrewFooter` colors/borders to scoped CSS variables (`--footer-*`) and Tailwind var classes to reduce inline color styling.
- Migrated `FloatingCartIconLink` button/pill/badge styles to scoped CSS variables (`--floating-cart-*`) with var utilities.
- Migrated `HeaderMenu` modal surface/link active states to scoped CSS variables (`--header-menu-*`) and utility classes for border/text theming consistency.
- Next beat: final T49.4 interaction-state regression sweep, then move to T49.5 AppContext decomposition audit.

## UPDATE 2026-02-27 (T49.4 order surface: SPA anchor cleanup + token vars)
- Converted residual `OrderPageClient` catalog return anchor to Next.js `Link` (same-origin SPA transition preserved).
- Added scoped `--order-*` CSS vars and migrated key accent/border usage (path chip, step circles, copilot accent labels, total/CTA).
- Captured `vip-bike` order-route screenshot smoke and re-verified lint/build after change.
- Next beat: run final cross-surface T49.4 interaction-state regression, then open T49.5 context decomposition audit.

## UPDATE 2026-02-27 (T49.4 order token pass #2)
- Reduced additional inline palette usage in `OrderPageClient` by moving delivery/payment toggles and copilot/promo/extras borders to `--order-*` var references.
- Preserved checkout behavior while tightening style-system consistency on order page interaction states.
- Re-ran lint/build and captured updated order-route screenshot smoke on `vip-bike`.
- Next beat: finalize T49.4 regression evidence and move into T49.5 context decomposition audit.

## UPDATE 2026-02-27 (T49.4 order token pass #3)
- Migrated milestone panel color states in `OrderPageClient` to `--order-*` vars (badge on-color/bg fallback, step color states, progress track/gradient endpoint).
- Kept checkout runtime behavior unchanged; this pass targets style-system consistency and interaction-state clarity only.
- Revalidated lint/build and captured updated screenshot on `/franchize/vip-bike/order/demo-order`.
- Next beat: run final multi-surface T49.4 regression checklist and move to T49.5 if green.

## UPDATE 2026-02-27 (T49.4 final polish before T49.5)
- `OrderPageClient` received one last cleanup pass: class-compatible inline var styles were moved to Tailwind var utility classes for promo/milestone/copilot/CTA controls.
- Focus-ring behavior remains via `focusRingOutlineStyle(...)`; no checkout logic changes.
- Lint/build/screenshot checks passed on `vip-bike` order route.
- Next planned task: start `T49.5` (AppContext decomposition + realtime strategy audit).

## UPDATE 2026-02-28 (T49 review hotfix: crash + compact-gap)
- Fixed **P1 regression** from review: `hooks/supabase.ts` no longer imports `@/lib/supabase-server`, so client modules that consume `@/hooks/supabase` no longer execute server-only `window` guard at bundle load.
- Fixed **P2 regression** from review: `CrewHeader` compact state now collapses row layout height via `max-height` + `overflow-hidden` wrapper, removing blank sticky gap while preserving transform/opacity animation.
- Revalidated with targeted lint + full build and captured updated visual smoke screenshot on `/franchize/vip-bike` after compact scroll.
- Next beat: merge this regression hotfix, then open T49.5 context decomposition track.
